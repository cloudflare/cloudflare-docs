{{- $dataArray := slice }}
{{- $availableOptions := slice -}}

{{- range readDir "./data/" -}}
{{- if in .Name ".yml" -}}
{{- $productName :=  replace .Name ".yml" "" -}}
{{ $dataArray = $dataArray | append (index $.Site.Data $productName) }}
{{- end -}}
{{- end -}}

{{- range $index, $item := $dataArray -}}
{{- with index (index $item "product") "group" -}}
{{- if ne (index (index $item "product") "show") false -}}
{{ $availableOptions = $availableOptions | append . }}
{{- end -}}
{{- end -}}
{{- end -}}
{{- $availableOptions = $availableOptions | uniq | sort -}}

<style>
  .optionsList {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-around;
  }

  .optionsList li {
    list-style-type: none;
  }

  .optionsList li a {
    text-decoration: none;
    color: inherit;
  --background-color-rgb: var(--orange-rgb);
  --background-color-alpha: 0.08;
  --border-bottom-color-rgb: var(--orange-3-rgb);
  --border-bottom-color-alpha: 0.3;
  --background-color: rgba(
    var(--background-color-rgb),
    var(--background-color-alpha)
  );
  background-color: var(--background-color);
  border-bottom: 1px solid
    rgba(var(--border-bottom-color-rgb), var(--border-bottom-color-alpha));
  }
  .optionsList li a:hover {
    --background-color-alpha: 0.2;
  }

  [theme="dark"] .optionsList li a {
    --background-color-alpha: 0.03;
    --border-bottom-color-rgb: var(--orange-rgb);
    --border-bottom-color-alpha: 0.35;
    color: var(--code-orange);
  }

  [theme="dark"] .optionsList li a:hover {
    --background-color-alpha: 0.1;
  }

  .ProductGrid--content {
    --n: 1;
    display: grid;
    flex-direction: column;
    grid-template-columns: repeat(var(--n), 1fr);
    gap: 5px;
    padding-bottom: 3em;
    border-bottom: 1px solid gray;
  }

  .ProductGrid--title {
    font-size: 2.5em;
    font-weight: 600;
    margin: 1.2em 0;
  }

  @media screen and (min-width: 600px) {
    .ProductGrid--content {
      --n: 2;
    }
  }

  @media screen and (min-width: 978px) {
    .ProductGrid--content {
      --n: 3;
    }
  }

  @media screen and (min-width: 1200px) {
    .ProductGrid--content {
      --n: 4;
    }
  }
</style>

<ul class="optionsList">
  {{- range $availableOptions -}}
  <li><a href="#{{ . | safeURL | anchorize }}">{{.}}</a></li>
  {{- end -}}
</ul>



<div class="ProductGrid">
  <div id="ProductGrid--range">
  {{- range $availableOptions -}}
  {{- $currentOption := . }}
  <h2 class="ProductGrid--title" style="padding-top:1em; padding-bottom:1em;font-size:2em;" id="{{ $currentOption | safeURL | anchorize }}"><span class="DocsMarkdown--header-anchor-positioner">
    <a
      class="DocsMarkdown--header-anchor Link Link-without-underline"
      href="#{{ $currentOption | safeURL | anchorize }}"
      >&#8203;â€‹</a
    >
  </span>
    <span>{{$currentOption}}</span>
    </h2>
  <div class="ProductGrid--content">
    {{- range $dataArray -}} 
      {{- if and (eq $currentOption .product.group) (ne .product.show false) -}}
        {{- $product := .product -}} 
        {{- $wrap := default false $product.wrap -}}
        <a
          class="ProductGrid--link"
          data-wrap-title="{{ $wrap }}"
          href="{{ $product.url }}"
        >
          <div>{{ safeHTML .logo }}</div>
          <span>{{ $product.title }}</span>
        </a>
        {{- end -}}
      {{- end -}}
  </div>
  {{- end -}}
</div>
</div>

<script>
  function filterProducts() {
    // Search input and items
    var input = document.getElementById("search"); // User input
    var query = input.value.toUpperCase(); // Make input non-case sensitive
    var grid = document.getElementById("ProductGrid--range"); // Convert Hugo range to JS
    var items = grid.getElementsByTagName("a"); // Extract tiles

    // TODO: Search by URL, description (i.e. "cloudflare one" = Cloudflare Zero Trust)

    // Iterate through products
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      var text = item.innerText.toUpperCase();
      if (text.indexOf(query) > -1) {
        item.style.display = "";
      } else {
        item.style.display = "none";
      }
    }
  }
</script>
