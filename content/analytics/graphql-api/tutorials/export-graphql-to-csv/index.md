---
pcx-content-type: tutorial
title: Export GraphQL data to CSV
---

# Export GraphQL data to CSV

This tutorial shows how to create a Python script to query the GraphQL API for
Network Analytics data and convert the response to comma-separated values (CSV).
Produced CSV could be easily ingested by tools like [Splunk][6] for further
visualization and usage.

Therefore, this example queries the `ipFlows1mAttacksGroups` [dataset][1],
which contains minutely aggregates of Network Analytics attack activity.

{{<Aside type="warning" header="Warning">}}

This tutorial uses Network Analytics v1 (NAv1) nodes. These nodes are planned to
be deprecated on March 31, 2022. For more information on migrating from Network
Analytics v1 to Network Analytics v2, refer to the [migration guide][5].

{{</Aside>}}

## Prerequisites

The tutorial requires a valid Cloudflare API Token with `Account Analytics:read`
permission. It also expects that account you are interested in is entitled to
access Network Analytics.

Scripts in this tutorial requires Python version 3.6 or higher.

If you are looking to configure a Cloudflare API Token for a specific account,
please refer to [Configure an Analytics API token][2]. Make sure you have access to the account.

## Set up a script with authentication

The first step is to set up the script and define the variables for further
authentication with the GraphQL API using a Cloudflare API token. The script
also provides variables to set the range of data to export.

This example queries for a seven-day period that ended yesterday.
{{<raw>}}<pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-python" language="python"><span class="CodeBlock--header">Set up script and authentication</span><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment">#!/usr/bin/env python3</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> pandas </span><span class="CodeBlock--token-keyword">as</span><span class="CodeBlock--token-plain"> pd</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">from</span><span class="CodeBlock--token-plain"> datetime </span><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> datetime</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> timedelta</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> requests</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-comment"># the endpoint of GraphQL API</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">url </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'https://api.cloudflare.com/client/v4/graphql/'</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># Customize these variables.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">file_dir </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-comment"># Must include trailing slash. If left blank,</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># csv will be created in the current directory.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">api_token </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'[your API token here]'</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">api_account </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'[your account ID here]'</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># Set most recent day as yesterday by default.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">offset_days </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">1</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># How many days worth of data do we want? By default, 7.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">historical_days </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">7</span><span class="CodeBlock--token-plain">
</span></div></span></span></span></code></pre>{{</raw>}}

## Calculate the date _n_ days ago

The `get_past_date()` function takes a number of days (`num_days`), subtracts
that value from today's date, and returns the date `num_days` ago.
{{<raw>}}<pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-python" language="python"><span class="CodeBlock--header">Calculates the datetime num_days ago and returns it in ISO format</span><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">get_past_date</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">num_days</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    today </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> datetime</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">utcnow</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">date</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> today </span><span class="CodeBlock--token-operator">-</span><span class="CodeBlock--token-plain"> timedelta</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">days</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain">num_days</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain">
</span></div></span></span></span></code></pre>{{</raw>}}

The script uses `get_past_date()` with the `offset_days` and `historical_days`
variables to calculate the appropriate date range (`min_date` and `max_date`)
when it queries the GraphQL API.

## Query the GraphQL API

The `get_cf_graphql()` function assembles and sends a request to the GraphQL
API. The headers will include the data for authentication.

The payload contains the GraphQL query. In this query, we would like to get a
list of the next fields for a given account and time range:

- attack ID
- attack type
- start time
- end time
- mitigation type
- avg, max rate of packets per second

To get started with GraphQL queries, please refer to [Querying basics][3].

The braces used in the GraphQL query are doubled to escape them in Python's
f-string.

GraphQL requires a query to be a single-line text, therefore we should remove
all newline symbols before sending it.
{{<raw>}}<pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-python" language="python"><span class="CodeBlock--header">Query the Network Analytics GraphQL API</span><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">get_cf_graphql</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">assert</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">start_date </span><span class="CodeBlock--token-operator">&lt=</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    headers </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">'Content-Type'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'application/json'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">'Authorization'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">f'Bearer </span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">api_token</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">'</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># The GQL query we would like to use:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    payload </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">f'''{{&quot;query&quot;:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      &quot;query ipFlowEventLog($accountTag: string) {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        viewer {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          accounts(</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            filter: {{ accountTag: $accountTag }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          ) {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            ipFlows1mAttacksGroups(</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              filter: $filter</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              limit: 10000</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              orderBy: [min_datetimeMinute_ASC]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            ) {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              dimensions {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackId</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackDestinationIP</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackMitigationType</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackType</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              avg {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                packetsPerSecond</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              min {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                datetimeMinute</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              max {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                datetimeMinute</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                packetsPerSecond</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      }}&quot;,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      &quot;variables&quot;: {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        &quot;accountTag&quot;: &quot;</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">api_account</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">&quot;,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        &quot;filter&quot;: {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          &quot;AND&quot;:[</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              &quot;date_geq&quot;: &quot;</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">start_date</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">&quot;</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            }},</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              &quot;date_leq&quot;: &quot;</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">end_date</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">&quot;</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          ]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">    }}'''</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    r </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> requests</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">post</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">url</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> data</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain">payload</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">replace</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'\n'</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> headers</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain">headers</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> r</span></div></span></span></span></code></pre>{{</raw>}}

## Convert the data to CSV

Use a tool such as the open-source [pandas][4] library (`pd`) to convert a
response from the GraphQL API (JSON) to CSV.

In this example, the `convert_to_csv()` function does some JSON processing
before conversion â€” normalizing the data, selecting only the desired data, and
renaming the columns so that they are user-friendly. The function also checks
whether the API responded successfully or we got an error.

The result is output to file in the directory specified by `file_dir`.
{{<raw>}}<pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-python" language="python"><span class="CodeBlock--header">Convert the data to CSV</span><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">convert_to_csv</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    data </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> pd</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">read_json</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> dtype</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-boolean">False</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'data'</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    errors </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> pd</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">read_json</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> dtype</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-boolean">False</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'errors'</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># Check if we got any errors</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> errors</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">notna</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-builtin">any</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">or</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">not</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'viewer'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">in</span><span class="CodeBlock--token-plain"> data </span><span class="CodeBlock--token-keyword">or</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">not</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'accounts'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">in</span><span class="CodeBlock--token-plain"> data</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'viewer'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'Failed to retrieve data: GraphQL API responded with error:'</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># Flatten nested JSON data first</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_normalized </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> pd</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">json_normalize</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">data</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'viewer'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'accounts'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'ipFlows1mAttacksGroups'</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-builtin">len</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">network_analytics_normalized</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">==</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">0</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'We got empty response'</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_abridged </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> network_analytics_normalized</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">[</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackId'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'min.datetimeMinute'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'max.datetimeMinute'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackMitigationType'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackType'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackDestinationIP'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'max.packetsPerSecond'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'avg.packetsPerSecond'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># Rename the columns to get friendly names</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_abridged</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">columns </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">[</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Attack ID'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Started at'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Ended at'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Action taken'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Attack type'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Destination IP'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Max packets/second'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Avg packets/second'</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-builtin">file</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">&quot;{}network-analytics-{}-{}.csv&quot;</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-builtin">format</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">file_dir</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_abridged</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">to_csv</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-builtin">file</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">&quot;Successfully exported to {}&quot;</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-builtin">format</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-builtin">file</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain">
</span></div></span></span></span></code></pre>{{</raw>}}

## The final script
{{<raw>}}<pre class="CodeBlock CodeBlock-with-rows CodeBlock-scrolls-horizontally CodeBlock-is-light-in-light-theme CodeBlock--language-python" language="python"><span class="CodeBlock--header">Get Cloudflare Network Analytics via GraphQL API in CSV format</span><code><span class="CodeBlock--rows"><span class="CodeBlock--rows-content"><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment">#!/usr/bin/env python3</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> pandas </span><span class="CodeBlock--token-keyword">as</span><span class="CodeBlock--token-plain"> pd</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">from</span><span class="CodeBlock--token-plain"> datetime </span><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> datetime</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> timedelta</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">import</span><span class="CodeBlock--token-plain"> requests</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-comment"># the endpoint of GraphQL API</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">url </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'https://api.cloudflare.com/client/v4/graphql/'</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># Customize these variables.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">file_dir </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-plain">  </span><span class="CodeBlock--token-comment"># Must include trailing slash. If left blank,</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># csv will be created in the current directory.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">api_token </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'[your API token here]'</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">api_account </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'[your account ID here]'</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># Set most recent day as yesterday by default.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">offset_days </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">1</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-comment"># How many days worth of data do we want? By default, 7.</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">historical_days </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">7</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">get_past_date</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">num_days</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    today </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> datetime</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">utcnow</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">date</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> today </span><span class="CodeBlock--token-operator">-</span><span class="CodeBlock--token-plain"> timedelta</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">days</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain">num_days</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">get_cf_graphql</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">assert</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">start_date </span><span class="CodeBlock--token-operator">&lt=</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    headers </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">'Content-Type'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'application/json'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-string">'Authorization'</span><span class="CodeBlock--token-punctuation">:</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">f'Bearer </span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">api_token</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">'</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-punctuation">}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># The GQL query we would like to use:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    payload </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">f'''{{&quot;query&quot;:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      &quot;query ipFlowEventLog($accountTag: string) {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        viewer {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          accounts(</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            filter: {{ accountTag: $accountTag }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          ) {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            ipFlows1mAttacksGroups(</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              filter: $filter</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              limit: 10000</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              orderBy: [min_datetimeMinute_ASC]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            ) {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              dimensions {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackId</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackDestinationIP</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackMitigationType</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                attackType</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              avg {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                packetsPerSecond</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              min {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                datetimeMinute</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              max {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                datetimeMinute</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">                packetsPerSecond</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      }}&quot;,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      &quot;variables&quot;: {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        &quot;accountTag&quot;: &quot;</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">api_account</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">&quot;,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        &quot;filter&quot;: {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          &quot;AND&quot;:[</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              &quot;date_geq&quot;: &quot;</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">start_date</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">&quot;</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            }},</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            {\{</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">              &quot;date_leq&quot;: &quot;</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">{</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation">end_date</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-interpolation CodeBlock--token-punctuation">}</span><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">&quot;</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">            }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">          ]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">        }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">      }}</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-string-interpolation CodeBlock--token-string">    }}'''</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    r </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> requests</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">post</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">url</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> data</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain">payload</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">replace</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'\n'</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">''</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> headers</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain">headers</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">return</span><span class="CodeBlock--token-plain"> r</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain"></span><span class="CodeBlock--token-keyword">def</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-function">convert_to_csv</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    data </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> pd</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">read_json</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> dtype</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-boolean">False</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'data'</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    errors </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> pd</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">read_json</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> dtype</span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-boolean">False</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'errors'</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># Check if we got any errors</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> errors</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">notna</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-builtin">any</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">or</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">not</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'viewer'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">in</span><span class="CodeBlock--token-plain"> data </span><span class="CodeBlock--token-keyword">or</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">not</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'accounts'</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-keyword">in</span><span class="CodeBlock--token-plain"> data</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'viewer'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'Failed to retrieve data: GraphQL API responded with error:'</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">raw_data</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># Flatten nested JSON data first</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_normalized </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> pd</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">json_normalize</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">data</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'viewer'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-string">'accounts'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">'ipFlows1mAttacksGroups'</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-builtin">len</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">network_analytics_normalized</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">==</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">0</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">'We got empty response'</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">        </span><span class="CodeBlock--token-keyword">return</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_abridged </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> network_analytics_normalized</span><span class="CodeBlock--token-punctuation">[</span><span class="CodeBlock--token-punctuation">[</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackId'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'min.datetimeMinute'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'max.datetimeMinute'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackMitigationType'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackType'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'dimensions.attackDestinationIP'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'max.packetsPerSecond'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'avg.packetsPerSecond'</span><span class="CodeBlock--token-punctuation">]</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-comment"># Rename the columns to get friendly names</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_abridged</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">columns </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-punctuation">[</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Attack ID'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Started at'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Ended at'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Action taken'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Attack type'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Destination IP'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Max packets/second'</span><span class="CodeBlock--token-punctuation">,</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">      </span><span class="CodeBlock--token-string">'Avg packets/second'</span><span class="CodeBlock--token-punctuation">]</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-builtin">file</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-string">&quot;{}network-analytics-{}-{}.csv&quot;</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-builtin">format</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">file_dir</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    network_analytics_abridged</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">to_csv</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-builtin">file</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">&quot;Successfully exported to {}&quot;</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-builtin">format</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-builtin">file</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">start_date </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> get_past_date</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">offset_days </span><span class="CodeBlock--token-operator">+</span><span class="CodeBlock--token-plain"> historical_days</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">end_date </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> get_past_date</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">offset_days</span><span class="CodeBlock--token-punctuation">)</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">req </span><span class="CodeBlock--token-operator">=</span><span class="CodeBlock--token-plain"> get_cf_graphql</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">if</span><span class="CodeBlock--token-plain"> req</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">status_code </span><span class="CodeBlock--token-operator">==</span><span class="CodeBlock--token-plain"> </span><span class="CodeBlock--token-number">200</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    convert_to_csv</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">req</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">text</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> start_date</span><span class="CodeBlock--token-punctuation">,</span><span class="CodeBlock--token-plain"> end_date</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain">
</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-keyword">else</span><span class="CodeBlock--token-punctuation">:</span></div></span><span class="CodeBlock--row"><span class="CodeBlock--row-indicator"></span><div class="CodeBlock--row-content"><span class="CodeBlock--token-plain">    </span><span class="CodeBlock--token-keyword">print</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-string">&quot;Failed to retrieve data: GraphQL API responded with {} status code&quot;</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-builtin">format</span><span class="CodeBlock--token-punctuation">(</span><span class="CodeBlock--token-plain">req</span><span class="CodeBlock--token-punctuation">.</span><span class="CodeBlock--token-plain">status_code</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-punctuation">)</span><span class="CodeBlock--token-plain">
</span></div></span></span></span></code></pre>{{</raw>}}

[1]: /analytics/graphql-api/features/data-sets/
[2]: /analytics/graphql-api/getting-started/authentication/api-token-auth/
[3]: /analytics/graphql-api/getting-started/querying-basics/
[4]: https://pandas.pydata.org/pandas-docs/stable/index.html
[5]: /analytics/graphql-api/migration-guides/network-analytics-v2/
[6]: https://www.splunk.com
